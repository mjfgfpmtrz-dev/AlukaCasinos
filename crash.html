<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crash Step 2</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont}
body{
  background:#0b1020;
  color:white;
  height:100vh;
  overflow:hidden;
}
.mult{
  position:absolute;
  top:70px;
  width:100%;
  text-align:center;
  font-size:52px;
  font-weight:700;
  text-shadow:0 0 20px #4fc3ff;
}
.mult.crash{color:#ff4444;text-shadow:0 0 25px red}
.timer{
  position:absolute;
  top:130px;
  width:100%;
  text-align:center;
  opacity:.6;
}
canvas{
  position:absolute;
  bottom:140px;
  width:100%;
  height:60%;
}
button{
  position:absolute;
  bottom:60px;
  left:50%;
  transform:translateX(-50%);
  padding:16px 30px;
  font-size:16px;
  border:none;
  border-radius:14px;
  background:#1e90ff;
  color:white;
}
button.gray{background:#2a2f45}
</style>
</head>

<body>

<div class="mult" id="mult">x1.00</div>
<div class="timer" id="timer">Ожидание: 5</div>
<canvas id="graph"></canvas>
<button id="btn">СДЕЛАТЬ СТАВКУ</button>

<script>
let state='WAIT';
let bet=false;
let timer=5;
let startTime=0;
let crashPoint=0;
let raf;

/* UI */
const multEl=mult=document.getElementById('mult');
const timerEl=document.getElementById('timer');
const btn=document.getElementById('btn');

/* Canvas */
const canvas=document.getElementById('graph');
const ctx=canvas.getContext('2d');
canvas.width=innerWidth;
canvas.height=innerHeight*0.6;

let path=[];

/* Crash point */
function getCrash(){
  const r=Math.random();
  if(r<0.7) return 1.2+Math.random()*1.3;
  if(r<0.9) return 2.5+Math.random()*2;
  return 5+Math.random()*4;
}

/* WAIT */
function wait(){
  state='WAIT';
  bet=false;
  timer=5;
  path=[];
  multEl.textContent='x1.00';
  multEl.classList.remove('crash');
  btn.textContent='СДЕЛАТЬ СТАВКУ';
  btn.className='';
  timerEl.textContent='Ожидание: '+timer;

  const t=setInterval(()=>{
    timer--;
    timerEl.textContent='Ожидание: '+timer;
    if(timer<=0){
      clearInterval(t);
      start();
    }
  },1000);
}

/* START */
function start(){
  state='FLY';
  startTime=performance.now();
  crashPoint=getCrash();
  timerEl.textContent='Раунд идёт';
  btn.textContent=bet?'ЗАБРАТЬ':'—';
  btn.className=bet?'':'gray';
  fly();
}

/* MULT CALC (ВАЖНО) */
function calcMultiplier(time){
  const t=time/1000;

  // медленный старт
  if(t < 1.8) return 1 + t*0.12;

  // основной разгон (экспонента)
  return 1.22 * Math.exp((t-1.8)/3);
}

/* FLY */
function fly(){
  if(state!=='FLY') return;

  const elapsed=performance.now()-startTime;
  const mult=calcMultiplier(elapsed);

  multEl.textContent='x'+mult.toFixed(2);

  path.push({x:path.length,y:mult});
  draw();

  if(mult>=crashPoint){
    crash(mult);
    return;
  }
  raf=requestAnimationFrame(fly);
}

/* DRAW GRAPH */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // grid
  ctx.strokeStyle='rgba(255,255,255,0.04)';
  for(let i=0;i<10;i++){
    ctx.beginPath();
    ctx.moveTo(0,i*canvas.height/10);
    ctx.lineTo(canvas.width,i*canvas.height/10);
    ctx.stroke();
  }

  // curve
  ctx.beginPath();
  ctx.strokeStyle='#4fc3ff';
  ctx.lineWidth=2;
  ctx.shadowColor='#4fc3ff';
  ctx.shadowBlur=12;

  path.forEach((p,i)=>{
    const x=i*4;
    const y=canvas.height-(p.y*70);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* CRASH */
function crash(m){
  state='CRASH';
  multEl.classList.add('crash');
  timerEl.textContent='CRASH x'+m.toFixed(2);
  btn.textContent='—';
  btn.className='gray';
  setTimeout(wait,2000);
}

/* BUTTON */
btn.onclick=()=>{
  if(state==='WAIT'){
    bet=!bet;
    btn.textContent=bet?'ОТМЕНИТЬ':'СДЕЛАТЬ СТАВКУ';
    btn.className=bet?'gray':'';
  }
  else if(state==='FLY' && bet){
    bet=false;
    btn.textContent='—';
    btn.className='gray';
    timerEl.textContent='Забрал на x'+multEl.textContent.slice(1);
  }
};

wait();
</script>
</body>
</html>