<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crash</title>

<style>
html,body{
  margin:0;
  background:#0b0f1a;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,Inter,Arial;
  overflow:hidden;
}

#app{position:relative;width:100vw;height:100vh}

canvas{position:absolute;inset:0}

#mult{
  position:absolute;
  top:120px;
  width:100%;
  text-align:center;
  font-size:42px;
  font-weight:700;
}

#countdown{
  position:absolute;
  top:120px;
  width:100%;
  text-align:center;
  font-size:72px;
  opacity:.8;
}

#controls{
  position:absolute;
  bottom:160px;
  width:100%;
  display:flex;
  justify-content:center;
}

#betBtn{
  width:88%;
  height:54px;
  border:none;
  border-radius:14px;
  background:#2b7cff;
  color:#fff;
  font-size:18px;
  font-weight:600;
}

#bets{
  position:absolute;
  bottom:0;
  width:100%;
  background:#111;
  padding:12px;
}

.bet{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 0;
  border-bottom:1px solid #1e2533;
}

.bet img{
  width:36px;
  height:36px;
  border-radius:8px;
  margin-right:8px;
}

.left{
  display:flex;
  align-items:center;
  font-size:14px;
}

.right{
  font-weight:600;
}

.red{color:#ff5252}
.green{color:#4caf50}

#panel{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
}

#panelBox{
  width:90%;
  background:#141a2b;
  border-radius:16px;
  padding:16px;
}

input{
  width:100%;
  height:44px;
  border-radius:10px;
  border:none;
  padding:0 12px;
  margin-bottom:10px;
  font-size:16px;
}
</style>
</head>

<body>
<div id="app">
  <canvas id="cv"></canvas>

  <div id="mult">x1.00</div>
  <div id="countdown"></div>

  <div id="controls">
    <button id="betBtn">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
  </div>

  <div id="bets"></div>

  <div id="panel">
    <div id="panelBox">
      <input id="betAmount" type="number" step="0.1" min="0.1" placeholder="–°—Ç–∞–≤–∫–∞ (TON)">
      <input id="autoX" type="number" step="0.01" placeholder="–ê–≤—Ç–æ-–≤—ã–≤–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
      <button id="confirmBet" style="width:100%;height:44px;border-radius:10px;background:#2b7cff;color:#fff;border:none">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* ================== CORE ================== */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
cv.width = innerWidth;
cv.height = innerHeight;

let state = 'WAIT';
let countdown = 5;
let mult = 1;
let tick;
let crashAt = 1;
let bet = null;

/* ================== NFT PROVIDER ================== */
async function getNFTByPrice(price){
  // üî• –ê–î–ê–ü–¢–ï–† –ü–û–î API
  // TODO: –∑–∞–º–µ–Ω–∏—Ç—å URL –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
  try{
    // –ø—Ä–∏–º–µ—Ä:
    // const r = await fetch(`https://api.marketplace.xyz/nft?price_lte=${price}`)
    // const data = await r.json()
    // return data[0]

    // FALLBACK
    return {
      image:'https://i.imgur.com/Z6X6xQZ.png',
      price:price.toFixed(2)
    }
  }catch(e){
    return {image:'https://i.imgur.com/Z6X6xQZ.png',price:price.toFixed(2)}
  }
}

/* ================== ROUND ================== */
function newRound(){
  mult = 1;
  crashAt = genCrash();
  countdown = 5;
  state = 'WAIT';
  bet = null;
}

function genCrash(){
  const r = Math.random();
  if(r < .35) return 1 + Math.random()*.1;
  if(r < .7) return 1.2 + Math.random()*1.3;
  if(r < .9) return 2 + Math.random()*3;
  return 5 + Math.random()*10;
}

function start(){
  state = 'FLY';
  tick = setInterval(()=>{
    let speed = mult < 1.4 ? 0.004 : mult < 2 ? 0.008 : 0.015;
    mult += speed;
    if(mult >= crashAt){
      explode();
    }
    if(bet?.autoX && mult >= bet.autoX){
      cashout();
    }
  },16);
}

function explode(){
  clearInterval(tick);
  state='CRASH';
  setTimeout(newRound,2000);
}

async function cashout(){
  clearInterval(tick);
  state='CASHOUT';
  const win = bet.amount * mult;
  const nft = await getNFTByPrice(win);
  alert(`NFT –∑–∞ ${nft.price} TON`);
  newRound();
}

/* ================== UI ================== */
const btn = document.getElementById('betBtn');
const panel = document.getElementById('panel');

btn.onclick=()=>{
  if(state==='WAIT' && !bet){
    panel.style.display='flex';
  }else if(state==='WAIT' && bet){
    bet=null;
  }else if(state==='FLY'){
    cashout();
  }
};

document.getElementById('confirmBet').onclick=()=>{
  const a = +betAmount.value;
  if(a>=0.1){
    bet={amount:a,autoX:+autoX.value||null};
    panel.style.display='none';
  }
};

/* ================== DRAW ================== */
function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);

  // GRID
  ctx.strokeStyle='#1e2533';
  for(let x=0;x<cv.width;x+=60){
    ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,cv.height);ctx.stroke();
  }
  for(let y=0;y<cv.height;y+=60){
    ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cv.width,y);ctx.stroke();
  }

  // CURVE
  ctx.strokeStyle='#6aff6a';
  ctx.lineWidth=4;
  ctx.beginPath();
  for(let i=0;i<mult*200;i++){
    const x=i*4;
    const y=cv.height-100-Math.pow(i/200,1.5)*500;
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  document.getElementById('mult').innerText=`x${mult.toFixed(2)}`;
  requestAnimationFrame(draw);
}

setInterval(()=>{
  if(state==='WAIT'){
    countdown--;
    document.getElementById('countdown').innerText=countdown;
    if(countdown<=0){
      document.getElementById('countdown').innerText='';
      start();
    }
  }
},1000);

newRound();
draw();
</script>
</body>
</html>